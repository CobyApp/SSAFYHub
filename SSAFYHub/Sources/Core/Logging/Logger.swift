import Foundation
import Dependencies
import os.log

// MARK: - Î°úÍ∑∏ Î†àÎ≤®
public enum LogLevel: String, CaseIterable, Comparable {
    case debug = "DEBUG"
    case info = "INFO"
    case warning = "WARNING"
    case error = "ERROR"
    case critical = "CRITICAL"
    
    public static func < (lhs: LogLevel, rhs: LogLevel) -> Bool {
        let levels: [LogLevel] = [.debug, .info, .warning, .error, .critical]
        guard let lhsIndex = levels.firstIndex(of: lhs),
              let rhsIndex = levels.firstIndex(of: rhs) else {
            return false
        }
        return lhsIndex < rhsIndex
    }
    
    public var osLogType: OSLogType {
        switch self {
        case .debug: return .debug
        case .info: return .info
        case .warning: return .default
        case .error: return .error
        case .critical: return .fault
        }
    }
    
    public var emoji: String {
        switch self {
        case .debug: return "üêõ"
        case .info: return "‚ÑπÔ∏è"
        case .warning: return "‚ö†Ô∏è"
        case .error: return "‚ùå"
        case .critical: return "üö®"
        }
    }
}

// MARK: - Î°úÍ∑∏ Ïπ¥ÌÖåÍ≥†Î¶¨
public enum LogCategory: String, CaseIterable {
    case general = "General"
    case network = "Network"
    case auth = "Authentication"
    case data = "Data"
    case ai = "AI"
    case ui = "UI"
    case performance = "Performance"
    case security = "Security"
    case widget = "Widget"
    
    public var subsystem: String {
        return "com.coby.ssafyhub"
    }
}

// MARK: - Î°úÍ∑∏ Ïª®ÌÖçÏä§Ìä∏
public struct LogContext {
    public let category: LogCategory
    public let function: String
    public let file: String
    public let line: Int
    public let timestamp: Date
    public let threadId: String
    public let userId: String?
    public let sessionId: String?
    public let additionalData: [String: Any]?
    
    public init(
        category: LogCategory,
        function: String = #function,
        file: String = #file,
        line: Int = #line,
        userId: String? = nil,
        sessionId: String? = nil,
        additionalData: [String: Any]? = nil
    ) {
        self.category = category
        self.function = function
        self.file = URL(fileURLWithPath: file).lastPathComponent
        self.line = line
        self.timestamp = Date()
        self.threadId = Thread.current.description
        self.userId = userId
        self.sessionId = sessionId
        self.additionalData = additionalData
    }
}

// MARK: - Î°úÍ±∞ ÌîÑÎ°úÌÜ†ÏΩú
public protocol LoggerProtocol {
    func log(_ level: LogLevel, _ message: String, _ context: LogContext)
    func debug(_ message: String, _ context: LogContext)
    func info(_ message: String, _ context: LogContext)
    func warning(_ message: String, _ context: LogContext)
    func error(_ message: String, _ context: LogContext)
    func critical(_ message: String, _ context: LogContext)
}

// MARK: - Ï§ëÏïôÌôîÎêú Î°úÍ±∞
public class AppLogger: LoggerProtocol {
    public static let shared = AppLogger()
    
    private let osLoggers: [LogCategory: OSLog]
    private let fileLogger: FileLogger
    private let consoleLogger: ConsoleLogger
    private let remoteLogger: RemoteLogger?
    
    private let minLogLevel: LogLevel
    private let enableConsoleLogging: Bool
    private let enableFileLogging: Bool
    private let enableRemoteLogging: Bool
    
    private init() {
        // ÏÑ§Ï†ïÍ∞íÎì§ (ÎÇòÏ§ëÏóê ÏÑ§Ï†ï ÏãúÏä§ÌÖúÍ≥º Ïó∞Îèô)
        self.minLogLevel = .debug
        self.enableConsoleLogging = true
        self.enableFileLogging = true
        self.enableRemoteLogging = false
        
        // OSLogger Ï¥àÍ∏∞Ìôî
        var loggers: [LogCategory: OSLog] = [:]
        for category in LogCategory.allCases {
            loggers[category] = OSLog(subsystem: category.subsystem, category: category.rawValue)
        }
        self.osLoggers = loggers
        
        // ÌååÏùº Î°úÍ±∞ Ï¥àÍ∏∞Ìôî
        self.fileLogger = FileLogger()
        
        // ÏΩòÏÜî Î°úÍ±∞ Ï¥àÍ∏∞Ìôî
        self.consoleLogger = ConsoleLogger()
        
        // ÏõêÍ≤© Î°úÍ±∞ Ï¥àÍ∏∞Ìôî (Ìñ•ÌõÑ Íµ¨ÌòÑ)
        self.remoteLogger = nil
        
        print("üîß AppLogger: Ï¥àÍ∏∞Ìôî ÏôÑÎ£å")
        print("   - ÏµúÏÜå Î°úÍ∑∏ Î†àÎ≤®: \(minLogLevel.rawValue)")
        print("   - ÏΩòÏÜî Î°úÍπÖ: \(enableConsoleLogging)")
        print("   - ÌååÏùº Î°úÍπÖ: \(enableFileLogging)")
        print("   - ÏõêÍ≤© Î°úÍπÖ: \(enableRemoteLogging)")
    }
    
    // MARK: - Í≥µÍ∞ú Î°úÍπÖ Î©îÏÑúÎìú
    public func log(_ level: LogLevel, _ message: String, _ context: LogContext) {
        // ÏµúÏÜå Î°úÍ∑∏ Î†àÎ≤® ÌôïÏù∏
        guard level >= minLogLevel else { return }
        
        // OS Î°úÍπÖ
        if let osLogger = osLoggers[context.category] {
            os_log("%{public}@", log: osLogger, type: level.osLogType, message)
        }
        
        // ÏΩòÏÜî Î°úÍπÖ
        if enableConsoleLogging {
            consoleLogger.log(level, message, context)
        }
        
        // ÌååÏùº Î°úÍπÖ
        if enableFileLogging {
            fileLogger.log(level, message, context)
        }
        
        // ÏõêÍ≤© Î°úÍπÖ
        if enableRemoteLogging, let remoteLogger = remoteLogger {
            remoteLogger.log(level, message, context)
        }
    }
    
    public func debug(_ message: String, _ context: LogContext) {
        log(.debug, message, context)
    }
    
    public func info(_ message: String, _ context: LogContext) {
        log(.info, message, context)
    }
    
    public func warning(_ message: String, _ context: LogContext) {
        log(.warning, message, context)
    }
    
    public func error(_ message: String, _ context: LogContext) {
        log(.error, message, context)
    }
    
    public func critical(_ message: String, _ context: LogContext) {
        log(.critical, message, context)
    }
    
    // MARK: - Ìé∏Ïùò Î©îÏÑúÎìú
    public func logNetwork(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .network, additionalData: additionalData)
        log(level, message, context)
    }
    
    public func logAuth(_ level: LogLevel, _ message: String, userId: String? = nil, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .auth, userId: userId, additionalData: additionalData)
        log(level, message, context)
    }
    
    public func logData(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .data, additionalData: additionalData)
        log(level, message, context)
    }
    
    public func logAI(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .ai, additionalData: additionalData)
        log(level, message, context)
    }
    
    public func logUI(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .ui, additionalData: additionalData)
        log(level, message, context)
    }
    
    public func logPerformance(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .performance, additionalData: additionalData)
        log(level, message, context)
    }
    
    public func logSecurity(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .security, additionalData: additionalData)
        log(level, message, context)
    }
    
    public func logWidget(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .widget, additionalData: additionalData)
        log(level, message, context)
    }
}

// MARK: - ÏΩòÏÜî Î°úÍ±∞
private class ConsoleLogger {
    func log(_ level: LogLevel, _ message: String, _ context: LogContext) {
        let timestamp = DateFormatter.logFormatter.string(from: context.timestamp)
        let emoji = level.emoji
        let category = context.category.rawValue
        
        let logMessage = "\(emoji) [\(timestamp)] [\(category)] \(message)"
        
        // Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Ìè¨Ìï®
        if let additionalData = context.additionalData, !additionalData.isEmpty {
            let dataString = additionalData.map { "\($0.key): \($0.value)" }.joined(separator: ", ")
            print("\(logMessage) | Data: \(dataString)")
        } else {
            print(logMessage)
        }
    }
}

// MARK: - ÌååÏùº Î°úÍ±∞
private class FileLogger {
    private let fileURL: URL
    private let queue = DispatchQueue(label: "com.coby.ssafyhub.filelogger", qos: .utility)
    
    init() {
        let documentsPath = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).first!
        let logsDirectory = documentsPath.appendingPathComponent("Logs")
        
        // Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
        try? FileManager.default.createDirectory(at: logsDirectory, withIntermediateDirectories: true)
        
        // Î°úÍ∑∏ ÌååÏùº URL (ÎÇ†ÏßúÎ≥ÑÎ°ú Î∂ÑÎ¶¨)
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        let fileName = "app_\(dateFormatter.string(from: Date())).log"
        self.fileURL = logsDirectory.appendingPathComponent(fileName)
        
        // Ïò§ÎûòÎêú Î°úÍ∑∏ ÌååÏùº Ï†ïÎ¶¨ (7Ïùº Ïù¥ÏÉÅ)
        cleanOldLogFiles(in: logsDirectory)
    }
    
    func log(_ level: LogLevel, _ message: String, _ context: LogContext) {
        queue.async { [weak self] in
            self?.writeToFile(level, message, context)
        }
    }
    
    private func writeToFile(_ level: LogLevel, _ message: String, _ context: LogContext) {
        let timestamp = DateFormatter.logFormatter.string(from: context.timestamp)
        let logEntry = "\(timestamp) [\(level.rawValue)] [\(context.category.rawValue)] \(context.file):\(context.line) - \(message)"
        
        if let data = (logEntry + "\n").data(using: .utf8) {
            if FileManager.default.fileExists(atPath: fileURL.path) {
                // ÌååÏùºÏóê Ï∂îÍ∞Ä
                if let fileHandle = try? FileHandle(forWritingTo: fileURL) {
                    fileHandle.seekToEndOfFile()
                    fileHandle.write(data)
                    fileHandle.closeFile()
                }
            } else {
                // ÏÉà ÌååÏùº ÏÉùÏÑ±
                try? data.write(to: fileURL)
            }
        }
    }
    
    private func cleanOldLogFiles(in directory: URL) {
        let fileManager = FileManager.default
        let maxAge: TimeInterval = 7 * 24 * 60 * 60 // 7Ïùº
        
        do {
            let files = try fileManager.contentsOfDirectory(at: directory, includingPropertiesForKeys: [.creationDateKey])
            let now = Date()
            
            for file in files {
                if let attributes = try? fileManager.attributesOfItem(atPath: file.path),
                   let creationDate = attributes[.creationDate] as? Date,
                   now.timeIntervalSince(creationDate) > maxAge {
                    try? fileManager.removeItem(at: file)
                }
            }
        } catch {
            print("‚ùå Î°úÍ∑∏ ÌååÏùº Ï†ïÎ¶¨ Ïã§Ìå®: \(error)")
        }
    }
}

// MARK: - ÏõêÍ≤© Î°úÍ±∞ (Ìñ•ÌõÑ Íµ¨ÌòÑ)
private class RemoteLogger {
    func log(_ level: LogLevel, _ message: String, _ context: LogContext) {
        // Ìñ•ÌõÑ Íµ¨ÌòÑ: Firebase Crashlytics, Sentry Îì±Í≥º Ïó∞Îèô
        // ÌòÑÏû¨Îäî ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî
    }
}

// MARK: - DateFormatter ÌôïÏû•
private extension DateFormatter {
    static let logFormatter: DateFormatter = {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd HH:mm:ss.SSS"
        formatter.timeZone = TimeZone.current
        return formatter
    }()
}

// MARK: - Dependencies ÌÜµÌï©
extension DependencyValues {
    var logger: LoggerProtocol {
        get { self[LoggerKey.self] }
        set { self[LoggerKey.self] = newValue }
    }
}

private enum LoggerKey: DependencyKey {
    static let liveValue: LoggerProtocol = AppLogger.shared
}

// MARK: - Ìé∏Ïùò Î©îÏÑúÎìú
public extension LoggerProtocol {
    /// ÎÑ§Ìä∏ÏõåÌÅ¨ Í¥ÄÎ†® Î°úÍ∑∏
    func logNetwork(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .network, additionalData: additionalData)
        log(level, message, context)
    }
    
    /// Ïù∏Ï¶ù Í¥ÄÎ†® Î°úÍ∑∏
    func logAuth(_ level: LogLevel, _ message: String, userId: String? = nil, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .auth, userId: userId, additionalData: additionalData)
        log(level, message, context)
    }
    
    /// Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ†® Î°úÍ∑∏
    func logData(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .data, additionalData: additionalData)
        log(level, message, context)
    }
    
    /// AI Í¥ÄÎ†® Î°úÍ∑∏
    func logAI(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .ai, additionalData: additionalData)
        log(level, message, context)
    }
    
    /// UI Í¥ÄÎ†® Î°úÍ∑∏
    func logUI(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .ui, additionalData: additionalData)
        log(level, message, context)
    }
    
    /// ÏÑ±Îä• Í¥ÄÎ†® Î°úÍ∑∏
    func logPerformance(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .performance, additionalData: additionalData)
        log(level, message, context)
    }
    
    /// Î≥¥Ïïà Í¥ÄÎ†® Î°úÍ∑∏
    func logSecurity(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .security, additionalData: additionalData)
        log(level, message, context)
    }
    
    /// ÏúÑÏ†Ø Í¥ÄÎ†® Î°úÍ∑∏
    func logWidget(_ level: LogLevel, _ message: String, additionalData: [String: Any]? = nil) {
        let context = LogContext(category: .widget, additionalData: additionalData)
        log(level, message, context)
    }
}
